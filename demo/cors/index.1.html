<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
    <title>iScroll demo: simple</title>
    <script>
        function Promise(fn) {
            var state = 'pending',
                value = null,
                callbacks = [];  //callbacks为数组，因为可能同时有很多个回调

            this.then = function (onFulfilled) {
                if (state === 'pending') {
                    callbacks.push(onFulfilled);
                    return this;/*能够链式调用*/
                }
                onFulfilled(value);/*在Promise异步操作成功这之后调用的then注册的回调也会执行*/
                return this;

                // return new Promise(function (resolve) {
                //     handle({
                //         onFulfilled: onFulfilled || null,
                //         resolve: resolve
                //     });
                // });
            };

            function handle(callback) {
                if (state === 'pending') {
                    callbacks.push(callback);
                    return;
                }
                //如果then中没有传递任何东西
                if (!callback.onFulfilled) {
                    callback.resolve(value);
                    return;
                }

                var ret = callback.onFulfilled(value);
                callback.resolve(ret);
            }

            function resolve(newValue) {
                value = newValue;
                state = 'fulfilled';
                setTimeout(function () {
                    callbacks.forEach(function (callback) {
                        callback(value);
                    });
                }, 0);
                /*setTimeout(fn,0) 等到同步任务和"任务队列"现有的事件都处理完，才会得到执行。*/
                /*通过setTimeout机制，将resolve中执行回调的逻辑放置到JS任务队列末尾，以保证在resolve执行时，then方法的回调函数已经注册完成.*/

                // if (newValue && (typeof newValue === 'object' || typeof newValue === 'function')) {
                //     var then = newValue.then;
                //     if (typeof then === 'function') {
                //         then.call(newValue, resolve);
                //         return;
                //     }
                // }
                // state = 'fulfilled';
                // value = newValue;
                // setTimeout(function () {
                //     callbacks.forEach(function (callback) {
                //         handle(callback);
                //     });
                // }, 0);
            }
            //使用到了闭包，通过闭包使用到了Promise内部函数resolve
            fn(resolve);
        }

        function getUserId() {
            return new Promise(function (resolve) {
                // setTimeout(function () {
                //     resolve('test');
                // }, 2000)
                resolve(9876);
            });
        }

        function getUserJobById(id) {
            return new Promise(function (resolve) {
                setTimeout(function () {
                    resolve('job'+id);
                }, 2000)
            });
        }

        // 例2
        getUserId().then(function (res) {
            console.log(res)
        }).then(function (res) {
            console.log(res)
        });

    </script>
</head>

<body>
    <div class="btn" id="btn"></div>
</body>

</html>